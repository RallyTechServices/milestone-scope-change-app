<!DOCTYPE html>
<html>
<head>
    <title>Milestone Scope Change App</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Tue May 30 2017 16:51:37 GMT-0700 (PDT) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Tue May 30 2017 16:51:37 GMT-0700 (PDT)";
        var STORY    = "US1453";
        var BUILDER  = "rajan08";
        var CHECKSUM = 10696067473;
    </script>
    
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns) 
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->
    
    
    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,items:[{xtype:"container",itemId:"information"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/var BUILDER  = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){if(text=a.responseText,CHECKSUM){var d=c._generateChecksum(text);if(CHECKSUM!==d)return void b.resolve(!1)}b.resolve(!0)}}),b.promise},_addToContainer:function(a){var b=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);a.add(b)},afterRender:function(){var a=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var b=this.down("#information");this._addToContainer(b)}a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){if(this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,doc:"top"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE){var a=Ext.String.format("Built on: {0} <br/>Built by: {1}",APP_BUILD_DATE,BUILDER);STORY&&(a=a+"<br/>Source story: "+STORY),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:a})}}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}),Ext.define("TSApp",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10},items:[{xtype:"container",itemId:"selector_box",layout:{type:"hbox"}},{xtype:"container",itemId:"display_box"}],integrationHeaders:{name:"TSApp"},seriesKeys:["BaselineScope","BaselineScopeInProgress","BaselineScopeCompleted","AddedScope","AddedScopeInProgress","AddedScopeCompleted"],launch:function(){var a=this;a._addSelectors()},_addSelectors:function(){var a=this;this.down("#selector_box").removeAll();var b=this.down("#selector_box");b.add([{xtype:"datefield",anchor:"100%",fieldLabel:"Start Date",name:"startDate",itemId:"startDate",labelWidth:100,margin:10},{xtype:"rallymilestonecombobox",itemId:"milestoneCombo",name:"milestoneCombo",fieldLabel:"MileStone (Target Date)",hideLabel:!1,margin:10,labelWidth:150},{xtype:"rallybutton",text:"Go!",margin:10,cls:"primary",listeners:{click:function(){a.milestone=a.down("#milestoneCombo"),console.log("milestone",a.down("#milestoneCombo").lastSelection[0].raw),console.log("startDate",a.down("#startDate")),a._onScopeChange()},scope:a}}])},_onScopeChange:function(){me=this,app=this,console.log("onScopeChange"),me.milestone=me.down("#milestoneCombo").lastSelection[0]&&me.down("#milestoneCombo").lastSelection[0].raw,me.startDate=me.down("#startDate").value,console.log("milestone",me.down("#milestoneCombo"),me.milestone),me.bundle={},Deft.Chain.pipeline([me._getMilestone,me._loadPreliminaryEstimateValues,me._loadPortfolioItemTypes,me._loadMileStones,me._queryStories,me._getSnapshots,me._process,me._setBaseline,me._categorize,me._prepareChartData,me._createChart],me).then({success:function(a){me.bundle=a},failure:function(a){console.log("failure",a),me.add({text:a})},scope:me})},_getMilestone:function(){console.log("_getMilestone");var a=Ext.create("Deft.Deferred"),b=this;return a.resolve({milestone:b.milestone}),a.promise},_loadAStoreWithAPromise:function(a,b,c,d,e){var f=Ext.create("Deft.Deferred");console.log("in _loadAStoreWithAPromise ");var g={model:a,fetch:b,filters:c,limit:"Infinity"};return _.isUndefined(d)||_.isNull(d)||(g.context=d),_.isUndefined(e)||_.isNull(e)||(g.order=e),Ext.create("Rally.data.wsapi.Store",g).load({callback:function(a,b,c){c?f.resolve(a):f.reject("Problem loading: "+b.error.errors.join(". "))}}),f.promise},_loadPreliminaryEstimateValues:function(a){var b=Ext.create("Deft.Deferred"),c=this;return console.log("_loadPreliminaryEstimateValues"),-1!==_.findIndex(_.keys(a),"prelimEstimateValues")?b.resolve(a):c._loadAStoreWithAPromise("PreliminaryEstimate",!0,[]).then({success:function(d){a.prelimEstimateValues=d,c.bundle=a,b.resolve(a)}}),b.promise},_loadPortfolioItemTypes:function(a){var b=this;console.log("_loadPortfolioItemTypes");var c=Ext.create("Deft.Deferred");return-1!==_.findIndex(_.keys(a),"piTypes")?c.resolve(a):b._loadAStoreWithAPromise("TypeDefinition",!0,[{property:"Ordinal",operator:"!=",value:-1}]).then({success:function(b){a.piTypes=b,c.resolve(a)}}),c.promise},_loadMileStones:function(a){var b=this;console.log("_loadMileStones",a);var c=a.milestone,d=Ext.create("Deft.Deferred");return b._loadAStoreWithAPromise("MileStone",["Name","TargetDate","TargetProject"],[{property:"Name",operator:"=",value:c.Name}]).then({success:function(b){a.milestones=_.filter(b,function(a){return a.get("Name")===c.Name}),d.resolve(a)},failure:function(a){d.reject(a)}}),d.promise},createFilterFromFeatures:function(a){var b=null;return _.each(a,function(a){b=null===b?Ext.create("Rally.data.wsapi.Filter",{property:"ObjectID",operator:"=",value:a.ObjectID}):b.or({property:"ObjectID",operator:"=",value:a.ObjectID})}),b},showItemsTable:function(a){var b=this,c=b.getScopeChangeFeatures(a.series.chart,a.x-1);b.scopeGrid=b.addScopeChangeTable(c,a.x),_.isUndefined(b.tabPanel)||b.remove(b.tabPanel);var d=b.createFilterFromFeatures(a.features);Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:["HierarchicalRequirement"],filters:[d],autoLoad:!0,enableHierarchy:!0,enablePostGet:!0,enableRootLevelPostGet:!0,listeners:{load:function(a,b,c){}}}).then({success:function(a){_.isUndefined(b.itemsTable)||b.remove(b.itemsTable),b.itemsTable=Ext.create("Rally.ui.grid.TreeGrid",{xtype:"rallytreegrid",store:a,context:b.getContext(),enableEditing:!1,enableBulkEdit:!1,shouldShowRowActionsColumn:!1,enableRanking:!1,columnCfgs:["Project","Name","Owner","PlanEstimate"]}),b.tabPanel=Ext.create("Ext.tab.Panel",{itemId:"seriesChangeTabs",items:[{title:"Series",itemId:"seriesTab",items:[b.itemsTable]},{title:"Change",itemId:"changeTab",items:[b.scopeGrid]}],listeners:{tabchange:function(a){b.activeTab=a.getActiveTab()},scope:b}}),b.activeTab&&b.tabPanel.setActiveTab(b.activeTab),b.add(b.tabPanel)}})},_loadIterations:function(a){var b=this;console.log("_loadIterations");var c=a.milestone,d=Ext.create("Deft.Deferred");return b._loadAStoreWithAPromise("Iteration",["Name","StartDate","EndDate"],[{property:"EndDate",operator:"<=",value:c.TargetDate},{property:"EndDate",operator:">",value:b.startDate}],{projectScopeDown:!1},"EndDate").then({success:function(b){a.iterations=_.sortBy(b,function(a){return a.get("EndDate")}),b.length>0?d.resolve(a):d.reject("No iterations found")},failure:function(a){d.reject(a)}}),d.promise},_querySet:function(){var a=this,b=a.getSetting("queryText");return!_.isUndefined(b)&&!_.isNull(b)&&""!=b},_queryStories:function(a){var b=this;console.log("_queryStories");var c=new Deft.Deferred,d=this.getSetting("queryText");if(console.log("QueryText",d,_.isNull(d)),b._querySet()){var e=Ext.create("TSStringFilter",{query_string:d});Ext.create("Rally.data.WsapiDataStore",{model:"HierarchicalRequirement",autoLoad:!0,limit:"Infinity",filters:[e,{property:"MileStones.Name",operator:"=",value:a.milestone.Name}],fetch:["ObjectID","FormattedID"],listeners:{scope:this,load:function(b,d,e,f){console.log("wsapi load",e,f),e?(console.log("query stories",_.map(d,function(a){return a.get("FormattedID")})),a.queryFeatureOids=_.map(d,function(a){return a.get("ObjectID")}),c.resolve(a)):c.reject("Error loading filter")}}})}else c.resolve(a);return c.promise},_getSnapshots:function(a){console.log("_getSnapshots");var b=this,c=a.milestones,d={};d=b._querySet()?{ObjectID:{$in:a.queryFeatureOids}}:{MileStones:{$in:_.map(c,function(a){return a.get("ObjectID")})},_TypeHierarchy:{$in:["HierarchicalRequirement"]}};var e=new Deft.Deferred;return Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,limit:1/0,listeners:{refresh:function(b){for(var c=[],d=0,f=b.getTotalCount();f>d;++d)c.push(b.getAt(d).data);a.snapshots=c,console.log("snapshots:",c.length),e.resolve(a)}},fetch:["FormattedID","ObjectID","_ValidTo","_ValidFrom","PlanEstimate","Name","ActualEndDate","ActualStartDate","ScheduleState","Owner"],hydrate:["Project","Owner","ScheduleState"],find:d}),e.getPromise()},_process:function(a){var b=this,c=new Deft.Deferred;_.each(a.snapshots,function(a){a.range=moment.range(a._ValidFrom,a._ValidTo)});var d=b.dateRange(a.milestone);return a.data=_.map(d,function(b,c){b._d.setHours(23),b._d.setMinutes(59),b._d.setSeconds(59);var d=_.filter(a.snapshots,function(a){return b.within(a.range)}),e=_.groupBy(d,"ObjectID"),f=_.map(_.keys(e),function(a){return _.last(_.sortBy(e[a],function(a){return moment(a._ValidFrom)}))});return f}),console.log("_process",a),c.resolve(a),c.promise},_setBaseline:function(a){var b=this,c=new Deft.Deferred,d=b.dateRange(a.milestone),e=moment();return a.todayIndex=_.findIndex(d,function(a){return a.year()===e.year()&&a.month()===e.month()&&a.date()===e.date()}),a.baselineIndex=b.getBaselineIndex(),a.baseline=_.clone(a.data[a.baselineIndex]),a.iterationIndices=b.dateIndexes(d,[moment(a.milestone.TargetDate)]),c.resolve(a),c.promise},_categorize:function(a){var b=function(b,c){var d=function(b){var d=_.findIndex(a.baseline,function(a){return a.ObjectID===b.ObjectID});return-1==d&&c>=a.baselineIndex?"Added":"Baseline"},e=function(a){return"Completed"==a.ScheduleState||"Accepted"==a.ScheduleState?"ScopeCompleted":"In-Progress"==a.ScheduleState?"ScopeInProgress":"Scope"};return d(b)+e(b)},c=new Deft.Deferred;me.dateRange(a.milestone);return a.data=_.map(a.data,function(a,c){return _.groupBy(a,function(a){return b(a,c)})}),c.resolve(a),c.promise},_prepareChartData:function(a){var b=this,c=new Deft.Deferred,d=b.getReducerFunction(),e=_.map(b.seriesKeys,function(b){return{name:b,data:_.map(a.data,function(c,e){if(_.isUndefined(c[b]))return{x:e,y:null,features:null};if(a.todayIndex>=0&&e>a.todayIndex+1)return{x:e,y:null,features:null};var f=d(c[b]);return f=b.indexOf("Baseline")>-1?f:-1*f,{x:e+1,y:f,features:c[b]}})}});return a.chartData={series:e},c.resolve(a),c.promise},_createChart:function(a){var b=new Deft.Deferred;return _.isUndefined(me.chart)||me.remove(me.chart),me.chart=Ext.create("Rally.technicalservices.scopeChangeChart",{itemId:"rally-chart",chartData:a.chartData,iterationIndices:a.iterationIndices,baselineIndex:a.baselineIndex,subtitle:me.getSetting("queryDescription"),app:me,listeners:{series_click:me.showItemsTable,scope:me}}),me.add(me.chart),b.resolve(a),b.promise},getReducerFunction:function(){var a=this,b=this,c=null,d=function(a){return a.length},e=function(a){return _.reduce(a,function(a,b){return a+b.PlanEstimate},0)},f=function(b){return _.reduce(b,function(b,c){var d=_.find(a.bundle.prelimEstimateValues,function(a){return c.PreliminaryEstimate===a.get("ObjectID")});return b+(_.isUndefined(d)?0:d.get("Value"))},0)};switch(b.getSetting("aggregateType")){case"Points":c=e;break;case"Count":c=d;break;case"Preliminary Estimate":c=f}return c},getBaselineIndex:function(){var a=this;return a.getSetting("baselineType")},_loadWsapiRecords:function(a){var b=Ext.create("Deft.Deferred"),c=this,d={model:"Defect",fetch:["ObjectID"]};return this.logger.log("Starting load:",a.model),Ext.create("Rally.data.wsapi.Store",Ext.Object.merge(d,a)).load({callback:function(a,d,e){e?b.resolve(a):(c.logger.log("Failed: ",d),b.reject("Problem loading: "+d.error.errors.join(". ")))}}),b.promise},getScopeChangeFeatures:function(a,b){var c=this,d=_.compact(_.flatten(_.map(a.series,function(a){return a.data[b].features}))),e=c.bundle.baseline,f=_.map(d,function(a){return a.FormattedID}),g=_.map(e,function(a){return a.FormattedID}),h=_.difference(g,f),i=_.difference(f,g),j=function(a,b){return _.find(a,function(a){return a.FormattedID===b})},k=_.map(h,function(a){var b=j(e,a);return b.Scope="Removed",b}),l=_.map(i,function(a){var b=j(d,a);return b.Scope="Added",b});return l.concat(k)},addScopeChangeTable:function(a,b){var c=new Ext.data.ArrayStore({fields:[{name:"Scope"},{name:"FormattedID"},{name:"Project"},{name:"Name"},{name:"ScheduleState"},{name:"PlanEstimate"}]});c.loadData(a);var d=new Ext.grid.GridPanel({store:c,columns:[{header:"Scope",sortable:!0,dataIndex:"Scope",flex:1},{header:"ID",sortable:!0,dataIndex:"FormattedID",flex:1},{header:"Project",sortable:!0,dataIndex:"Project",flex:1,renderer:function(a){return a.Name}},{header:"Name",sortable:!0,dataIndex:"Name",width:250,flex:1},{header:"ScheduleState",sortable:!0,dataIndex:"ScheduleState",flex:1},{header:"Size",sortable:!0,dataIndex:"PlanEstimate",flex:1}],stripeRows:!0,title:"Scope Change Since Baseline for Day: "+b});return d},dateRange:function(a){var b=[];console.log(moment(me.startDate),moment(a.TargetDate));var c=moment.range(moment(me.startDate),moment(a.TargetDate));return c.by("days",function(a){b.push(moment(a.format("M/D/YYYY")))},!1),b},_displayGrid:function(a,b){this.down("#display_box").add({xtype:"rallygrid",store:a,columnCfgs:b})},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})},isExternal:function(){return"undefined"==typeof this.getAppId()}});
            
               Rally.launchApp('TSApp', {
                   name: 'Milestone Scope Change App'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}
    </style>

</head>
<body></body>
</html>